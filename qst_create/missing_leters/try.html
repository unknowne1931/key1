<!-- 1931 -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <title>Spelling Puzzle - 4 Smart Options</title>
  <style>
    body {
      font-family: sans-serif;
      background: #fdfcf7;
      text-align: center;
      padding: 40px;
    }
    .answer {
      font-size: 20px;
      font-weight: bold;
      color: green;
      margin-bottom: 10px;
    }
    .puzzle {
      font-size: 36px;
      margin-bottom: 25px;
      letter-spacing: 10px;
      border: 1px solid #ccc;
      height: 200px;
      width: 400px;
      margin: auto;
      font-family: 'Courier New', Courier, monospace;
      font-weight: 600;
      align-content: center;
      border-radius: 10px;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .options button {
      display: inline-block;
      margin: 10px;
      padding: 12px 24px;
      font-size: 20px;
      cursor: pointer;
      background: #fff;
      border: 2px solid #ccc;
      border-radius: 8px;
      transition: background 0.2s ease;
    }
    .options button:hover {
      background: #f0f0ff;
    }
    #result {
      margin-top: 20px;
      font-size: 22px;
      font-weight: bold;
    }
    button, select {
      margin-top: 20px;
      padding: 10px 15px;
      font-weight: bold;
      font-size: 16px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h2>üî† Spelling Puzzle - 4 Options Only</h2>
  <div id="showAnswer" class="answer"></div>
  <div class="puzzle" id="maskedWord"></div>
  <div class="options" id="options"></div>
  <div id="result"></div>

  <select id="tough_level">
    <option value="" selected disabled>Choose an option</option>
    <option value="Too Easy">Too Easy</option>
    <option value="Easy">Easy</option>
    <option value="Medium">Medium</option>
    <option value="Tough">Tough</option>
    <option value="Too Tough">Too Tough</option>
  </select>

  <div id="previewContainer"></div>

  <button id="btnCapture" class="submit_btn">Capture Screenshot</button>
  <button id="btnUpload" class="submit_btn" disabled>Upload Screenshot</button>

  <script>
    const words = [
      "cat", "cow", "pig", "goat", "sheep", "hen", "duck", "horse", "frog", "ant",
      "bee", "fox", "bat", "monkey", "bear", "wolf", "deer", "mouse", "panda", "whale",
      "dolphin", "crab", "shark", "snail", "camel", "turtle", "owl", "parrot", "rabbit", "kangaroo"
    ];

    let currentIndex = Math.floor(Math.random() * words.length);
    let currentPuzzle = null;
    let capturedBlob = null;
    let ans = null;

    function maskWord(word) {
      const count = Math.min(4, Math.max(2, Math.floor(word.length / 3)));
      const indexes = [];
      while (indexes.length < count) {
        const i = Math.floor(Math.random() * word.length);
        if (!indexes.includes(i)) indexes.push(i);
      }
      indexes.sort((a, b) => a - b);
      const masked = word.split("").map((ch, i) => indexes.includes(i) ? "_" : ch).join("");
      const correctFill = indexes.map(i => word[i]).join("");
      return { masked, correctFill };
    }

    function generateSimilarOptions(correct, count) {
      const options = new Set();
      const alphabet = "abcdefghijklmnopqrstuvwxyz";

      while (options.size < count) {
        let chars = correct.split("");
        const type = Math.floor(Math.random() * 3);
        if (type === 0 && chars.length > 1) {
          const i = Math.floor(Math.random() * (chars.length - 1));
          [chars[i], chars[i + 1]] = [chars[i + 1], chars[i]];
        } else {
          const i = Math.floor(Math.random() * chars.length);
          chars[i] = alphabet[Math.floor(Math.random() * 26)];
        }
        const variant = chars.join("");
        if (variant !== correct) options.add(variant);
      }

      return [...options];
    }

    function createPuzzle(word) {
      const { masked, correctFill } = maskWord(word);
      const fakeOptions = generateSimilarOptions(correctFill, 10);
      let options = [];
      let isAnswerNoneOfTheAbove = false;

      const includeNoneOption = Math.random() < 0.5;

      if (includeNoneOption) {
        const includeCorrect = Math.random() < 0.5;
        if (includeCorrect) {
          options = fakeOptions.slice(0, 2);
          options.push(correctFill);
          isAnswerNoneOfTheAbove = false;
        } else {
          options = fakeOptions.slice(0, 3);
          isAnswerNoneOfTheAbove = true;
        }
        options.push("None of the above");
      } else {
        options = fakeOptions.slice(0, 3);
        const insertIndex = Math.floor(Math.random() * 4);
        options.splice(insertIndex, 0, correctFill);
        isAnswerNoneOfTheAbove = false;
      }

      options = options.sort(() => Math.random() - 0.5);
      ans = correctFill;

      const isCorrectAnswer = (selected) => {
        if (selected === "None of the above") {
          ans = "None of the above"
          return isAnswerNoneOfTheAbove;
        } else {
          return selected === correctFill && !isAnswerNoneOfTheAbove;
        }
      };

      return {
        maskedWord: masked,
        correctFill,
        options,
        isCorrectAnswer,
        isAnswerNoneOfTheAbove
      };
    }

    function loadPuzzle() {
      const word = words[currentIndex];
      currentPuzzle = createPuzzle(word);

      document.getElementById("maskedWord").textContent = currentPuzzle.maskedWord;
      document.getElementById("showAnswer").innerHTML =
        `<span style="color:blue; font-weight:bold;">Answer: ${currentPuzzle.correctFill}</span>`;

      const optionsDiv = document.getElementById("options");
      optionsDiv.innerHTML = "";

      currentPuzzle.options.forEach(opt => {
        const btn = document.createElement("button");
        btn.textContent = opt;
        btn.onclick = () => checkAnswer(opt, currentPuzzle.isCorrectAnswer);
        optionsDiv.appendChild(btn);
      });

      document.getElementById("result").textContent = "";
    }

    function checkAnswer(selected, isCorrectFn) {
      const result = document.getElementById("result");
      const isCorrect = isCorrectFn(selected);

      if (isCorrect) {
        if (selected === "None of the above") {
          result.innerHTML =
            `‚úÖ Correct!<br><span style="color:blue; font-weight:bold;">Answer: None of the above (Real: ${currentPuzzle.correctFill})</span>`;
        } else {
          ans = currentPuzzle.correctFill;
          result.innerHTML =
            `‚úÖ Correct!<br><span style="color:blue; font-weight:bold;">Answer: ${currentPuzzle.correctFill}</span>`;
        }
      } else {
        result.innerHTML = `‚ùå Wrong!<br><span style="color:blue; font-weight:bold;">Answer: ${currentPuzzle.correctFill}</span>`;
      }

      setTimeout(() => {
        currentIndex = (currentIndex + 1) % words.length;
        loadPuzzle();
      }, 3000);
    }

    document.getElementById("btnCapture").addEventListener("click", function () {
      const element = document.querySelector(".puzzle");
      html2canvas(element).then(canvas => {
        canvas.toBlob(blob => {
          capturedBlob = blob;
          const url = URL.createObjectURL(blob);
          document.getElementById("previewContainer").innerHTML = `<img src="${url}" alt="Preview">`;
          document.getElementById("btnUpload").disabled = false;
        }, 'image/png');
      });
    });

    document.getElementById("btnUpload").addEventListener("click", function () {
      if (!capturedBlob) return alert("No screenshot captured!");

      const formData = new FormData();
      formData.append("screenshot", capturedBlob, "screenshot.png");

      fetch("https://backend.stawro.com/stawro/upload.php", {
        method: "POST",
        body: formData
      })
      .then(res => res.json())
      .then(res => {
        if (res.status) {
          post(res.path);
          alert(`‚úÖ ${res.status}\nüìÅ Path: https://backend.stawro.com/stawro/${res.path}`);
        } else {
          alert("Upload succeeded.");
          window.location.reload();
        }
      })
      .catch(err => {
        console.error("Upload error:", err);
        alert("‚ùå Upload error.");
      });
    });

    function post(imagePath) {
      let an = '';

      if((currentPuzzle.options).includes(ans)){
        an = ans
      }else{
        an = "None of the above"
      }
      if (!currentPuzzle) return alert("No puzzle loaded.");

      const difficulty = document.getElementById("tough_level").value || "Medium";

      fetch("http://localhost/api/question", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          question: `Fill in the blanks: ${currentPuzzle.maskedWord}`,
          answer: an,
          a: currentPuzzle.options[0],
          b: currentPuzzle.options[1],
          c: currentPuzzle.options[2],
          d: currentPuzzle.options[3],
          language: "English",
          category: "Spelling",
          difficulty,
          type: "Mental Ability",
          image: `https://backend.stawro.com/stawro/${imagePath}`,
          seconds: "10"
        })
      })
      .then(res => res.json())
      .then(data => {
        loadPuzzle();
        alert("‚úÖ Question posted successfully!");
      })
      .catch(error => {
        console.error("‚ùå Error posting question:", error);
        alert("‚ùå Error posting question. Check CORS and endpoint path.");
      });
    }

    loadPuzzle();
  </script>
</body>
</html>