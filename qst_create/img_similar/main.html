<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <title>Find Matching Images ‚Äì Challenge Mode</title>
  <style>
    body {
      font-family: sans-serif;
      background: #f3f4f6;
      display: flex;
      justify-content: center;
    }
    .quiz-box {
      background: rgb(255, 255, 255);
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      width: 100%;
      text-align: center;
    }
    .images-container {
      display: flex;
      flex-wrap: wrap;
      border: 1px solid;
      align-content: center;
      justify-content: center;
      background-color: #000000;
      border-radius: 5px;
      width: 700px;
      padding: 10px;
      margin: auto;
    }

    .image-block {
      position: relative;
      width: 250px;
      margin: 5px;
    }
    .image-block img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 10px;
      border: 2px solid #ccc;
    }
    .label {
      position: absolute;
      top: 6px;
      left: 6px;
      background: #000000;
      color: #fff;
      padding: 3px 6px;
      font-size: 14px;
      font-weight: bold;
      border-radius: 5px;
    }
    .options {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1px;
      margin-top: 50px;
    }
    .option-btn {
      padding: 10px 16px;
      border: 2px solid #3b82f6;
      background: white;
      color: #3b82f6;
      font-size: 16px;
      border-radius: 10px;
      cursor: pointer;
      width: 220px;
      transition: 0.2s;
    }
    .option-btn:hover {
      background: #3b82f6;
      color: white;
    }
    .option-btn.selected {
      background: #2563eb;
      color: white;
    }
    .option-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .feedback {
      margin-top: 20px;
      font-size: 18px;
      font-weight: bold;
    }
    #next-btn {
      margin-top: 20px;
      padding: 10px 20px;
      font-size: 16px;
      border: none;
      background: #10b981;
      color: white;
      border-radius: 8px;
      cursor: pointer;
      display: none;
    }

    .btn{
      width: 160px;
      height: 50px;
      background-color: #4CAF50; /* Green */
      color: white;
      border: 1px solid #4CAF50;
      border-radius: 30px;
      font-size: 15px;
      font-family: 'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;
    }

    select{
      width: 180px;
      text-align: center;
      font-family: 'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;
      font-weight: 600;
      border: 2px solid #0077ff;
      border-radius: 30px;
    }

    #ans{
      font-family: 'Courier New', Courier, monospace;
      font-weight: 600;
      color: green;
      font-size: large;
    }


  </style>
</head>
<body>

<div class="quiz-box">
  <h2>Which Images Match?</h2>
  <p id="ans"></p>
  <div class="images-container" id="images-container"></div>
  <div class="options" id="options-container"></div>
  <div class="feedback" id="feedback"></div>
  <br/>
  <button id="next-btn" onclick="setupQuiz()">Next</button>

  <select id="difficulty" style="margin: 20px; padding: 10px; font-size: 16px;">
    <option value="" selected>Select</option>
    <option value="Too Easy">Too Easy</option>
    <option value="Easy">Easy</option>
    <option value="Medium">Medium</option>
    <option value="Tough">Tough</option>
    <option value="Too Tough">Too Tough</option>
  </select>
  <br/>

  <!-- Preview container for screenshot -->
    <div id="previewContainer"></div>

  <button class="btn" id="btnCapture">Capture Screenshot</button>
  <button class="btn" id="btnUpload" disabled>Upload Screenshot</button>

  <div
    style="height: 50px;"
  ></div>



</div>

<script>
  
  let opt = [];
  
  /* Show images 2 per row */
  const style = document.createElement('style');
  document.head.appendChild(style);
  const allImages = [
    "1.png",
    "2.png",
    "3.png",
    "4.png",
  ];


  const labels = ['A', 'B', 'C', 'D'];
  let correctAnswer = "None of those";

  function shuffle(array) {
    for (let i = array.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [array[i], array[j]] = [array[j], array[i]];
    }
    return array;
  }

  function getRandomOptions(correct, labelSet) {
    const allPairs = [];
    for (let i = 0; i < labelSet.length; i++) {
      for (let j = i + 1; j < labelSet.length; j++) {
        const pair = `${labelSet[i]},${labelSet[j]}`;
        allPairs.push(pair);
      }
    }

    const options = new Set();
    if (correct !== "None of those") options.add(correct);
    while (options.size < 3) {
      const random = allPairs[Math.floor(Math.random() * allPairs.length)];
      if (random !== correct) options.add(random);
    }
    options.add("None of those");

    return shuffle(Array.from(options));
  }

  function setupQuiz() {
    document.getElementById("feedback").textContent = "";
    document.getElementById("next-btn").style.display = "none";
    document.getElementById("options-container").innerHTML = "";

    const useDuplicate = Math.random() < 0.75;
    const selectedImages = shuffle([...allImages]).slice(0, 3);
    if (useDuplicate) {
      const dup = selectedImages[Math.floor(Math.random() * selectedImages.length)];
      selectedImages.push(dup);
    } else {
      selectedImages.push(allImages[4]);
    }

    shuffle(selectedImages);

    const imageContainer = document.getElementById("images-container");
    imageContainer.innerHTML = "";

    selectedImages.forEach((url, i) => {
      const block = document.createElement("div");
      block.className = "image-block";
      const img = document.createElement("img");
      img.src = url;
      const label = document.createElement("div");
      label.className = "label";
      label.textContent = labels[i];
      block.appendChild(img);
      block.appendChild(label);
      imageContainer.appendChild(block);
    });

    // Find matching pair (correct answer)
    correctAnswer = "None of those";
    const seen = {};
    selectedImages.forEach((img, idx) => {
      if (seen[img] !== undefined) {
        const pair = [labels[seen[img]], labels[idx]].sort().join(',');
        correctAnswer = pair;
      } else {
        seen[img] = idx;
      }
    });

    const options = getRandomOptions(correctAnswer, labels);
    const container = document.getElementById("options-container");

    opt = options;



    options.forEach(option => {
      const btn = document.createElement("button");
      btn.className = "option-btn";
      btn.textContent = option === "None of those" ? "None of those" : option.replace(",", " & ");
      btn.onclick = () => handleAnswer(btn, option);
      container.appendChild(btn);
    });

    document.getElementById('ans').innerText = `Correct Answer : ${correctAnswer}`

  }


  function handleAnswer(button, choice) {
    document.querySelectorAll(".option-btn").forEach(btn => {
      btn.disabled = true;
      btn.classList.remove("selected");
    });
    button.classList.add("selected");

    const fb = document.getElementById("feedback");
    if (choice === correctAnswer) {
      fb.textContent = "‚úÖ Correct!";
    } else {
      fb.textContent = `‚ùå Wrong! Correct was: ${
        correctAnswer === "None of those"
          ? "None of those"
          : correctAnswer.replace(",", " & ")
      }`;
    }

    document.getElementById("next-btn").style.display = "inline-block";
  }

  setupQuiz();


  let capturedBlob = null;



    // Capture screenshot button
    document.getElementById("btnCapture").addEventListener("click", function () {
      const element = document.querySelector(".images-container");

      html2canvas(element).then(canvas => {
        canvas.toBlob(blob => {
          capturedBlob = blob;

          // Preview image
          const url = URL.createObjectURL(blob);
          document.getElementById("previewContainer").innerHTML = `<img src="${url}" alt="Preview">`;

          // Enable upload
          document.getElementById("btnUpload").disabled = false;
        }, 'image/png');
      });
    });

    // Upload screenshot button
    document.getElementById("btnUpload").addEventListener("click", function () {
      if (!capturedBlob) return alert("No screenshot captured!");

      const formData = new FormData();
      formData.append("screenshot", capturedBlob, "screenshot.png");

      fetch("https://backend.stawro.com/stawro/upload.php", {
        method: "POST",
        body: formData
      })
      .then(res => {
          if (!res.ok) throw new Error(`Server error: ${res.status}`);
          return res.json();
        })
        .then(res => {
          if (res.status) {
            post(res.filename) // Uncomment if you have this function defined
            alert(`‚úÖ ${res.status}\nüìÅ Path: https://backend.stawro.com/stawro/${res.path}`);

          } else {
            alert("Upload succeeded.");
            window.location.reload();
          }
        })
        .catch(err => {
          console.error("Upload error:", err);
          alert("‚ùå Upload error.");
        });
    });


    function post(path) {
  const difficulty = document.querySelector("select")?.value || "Medium"; // fallback value

  fetch("http://localhost/api/question", {
    method: "POST",
    headers: {
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      question: "Which Images Match?",
      answer: correctAnswer,
      a: opt[0],
      b: opt[1],
      c: opt[2],
      d: opt[3],
      language: "English",
      category: "similar_images",
      difficulty: difficulty,
      type: "Mental Ability",
      image: `https://backend.stawro.com/stawro/uploads/${path}`,
      seconds: 15
    })
  })
  .then(res => {
    if (!res.ok) {
      throw new Error(`Server returned status ${res.status}`);
    }
    return res.json();
  })
  .then(data => {
    alert("‚úÖ Question posted successfully!");
    Optionally: window.location.reload();
  })
  .catch(error => {
    console.error("‚ùå Error posting question:", error);
    alert("‚ùå Error posting question. Check CORS and endpoint path.");
  });
}

</script>

</body>
</html>
